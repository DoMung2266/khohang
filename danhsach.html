<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìã Danh s√°ch s·∫£n ph·∫©m</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .top-bar input, .top-bar select {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .btn-back {
      background: #0078d7;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    h2 {
      text-align: center;
      color: #0078d7;
      margin-bottom: 20px;
    }

    .product {
      background: white;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }

    .product img {
      max-width: 100%;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .info div {
      margin-bottom: 6px;
      font-size: 16px;
    }

    .label {
      font-weight: bold;
      color: #333;
    }

    @media (max-width: 600px) {
      .top-bar input, .top-bar select { font-size: 18px; }
      h2 { font-size: 20px; }
      .info div { font-size: 15px; }
    }
  </style>
</head>
<body>

  <button class="btn-back" onclick="window.location.href='index.html'">‚Ü©Ô∏è Quay v·ªÅ trang ch√≠nh</button>
  <h2>üì¶ Danh s√°ch s·∫£n ph·∫©m</h2>

  <div class="top-bar">
    <select id="brandFilter">
      <option value="">-- T·∫•t c·∫£ h√£ng --</option>
    </select>
    <input type="text" id="searchInput" placeholder="üîç T√¨m s·∫£n ph·∫©m..." />
    <select id="searchType">
      <option value="all">T√™n & M√£ s·ªë</option>
      <option value="name">Ch·ªâ t√™n</option>
      <option value="code">Ch·ªâ m√£ s·ªë</option>
    </select>
  </div>

  <div id="productList">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>

  <script>
    let allProducts = [];

    const accessToken = localStorage.getItem("dropbox_token");
    if (!accessToken) {
      alert("üö´ B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p token! Quay v·ªÅ trang ch√≠nh...");
      window.location.href = "index.html";
    }

    async function fetchProducts() {
      try {
        const res = await fetch("https://content.dropboxapi.com/2/files/download", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + accessToken,
            "Dropbox-API-Arg": JSON.stringify({ path: "/hangmau/products.json" })
          }
        });

        if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m.");
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.");

        allProducts = data;
        renderFilters(data);
        renderList();
      } catch (err) {
        document.getElementById("productList").innerHTML = `‚ùå ${err.message}`;
      }
    }

    function renderFilters(products) {
      const brandSet = new Set(products.map(p => p.brand).filter(Boolean));
      const brandSelect = document.getElementById("brandFilter");
      brandSet.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
      });
    }

    function renderList() {
      const list = document.getElementById("productList");
      const searchValue = document.getElementById("searchInput").value.trim().toLowerCase();
      const selectedBrand = document.getElementById("brandFilter").value;
      const searchType = document.getElementById("searchType").value;

      const filtered = allProducts.filter(p => {
	  const matchName = p.name?.toLowerCase().includes(searchValue);
      const matchCode = p.code?.toLowerCase().includes(searchValue);
      const brandMatch = selectedBrand ? p.brand === selectedBrand : true;

      let typeMatch = true;
      if (searchType === "name") typeMatch = matchName;
      else if (searchType === "code") typeMatch = matchCode;
      else typeMatch = matchName || matchCode;

      return brandMatch && typeMatch;
});

   list.innerHTML = filtered.length === 0
      ? "<p>üôà Kh√¥ng c√≥ s·∫£n ph·∫©m ph√π h·ª£p.</p>"
      : filtered.map(p => {
      const timeStr = new Date(p.time).toLocaleString("vi-VN");
      const imgURL = p.image.startsWith("http")
      ? p.image
      : "https://dl.dropboxusercontent.com" + p.image;

    return `
      <div class="product">
        <img src="${imgURL}" alt="${p.name}" />
        <div class="info">
          <div><span class="label">T√™n:</span> ${p.name}</div>
          <div><span class="label">M√£ s·ªë:</span> ${p.code}</div>
          <div><span class="label">H√£ng:</span> ${p.brand}</div>
          <div><span class="label">Quy c√°ch:</span> ${p.specs}</div>
          <div><span class="label">Lo·∫°i g·ªó:</span> ${p.woodType}</div>
          <div><span class="label">Kh√°c:</span> ${p.extra}</div>
          <div><span class="label">M√¥ t·∫£:</span> ${p.description || "‚Äî"}</div>
          <div><span class="label">Th·ªùi gian:</span> ${timeStr}</div>
        </div>
      </div>
    `;
  }).join("");
    }

    document.getElementById("searchInput").addEventListener("input", renderList);
    document.getElementById("brandFilter").addEventListener("change", renderList);
    document.getElementById("searchType").addEventListener("change", renderList);

    window.addEventListener("DOMContentLoaded", fetchProducts);
  </script>

</body>
</html>
