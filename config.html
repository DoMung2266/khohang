<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω h√£ng s·∫£n ph·∫©m</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f2f6fc;
    }

    .wrapper {
      max-width: 800px;
      margin: auto;
    }

    h2 {
      text-align: center;
      color: #0078D7;
      margin-bottom: 20px;
    }

    .btn-back {
      display: block;
      margin-bottom: 20px;
      background-color: #f39c12;
      color: white;
      text-decoration: none;
      padding: 10px 18px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 16px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: background 0.3s ease;
    }

    .btn-back:hover {
      background-color: #e67e22;
    }

    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .input-group input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 200px;
    }

    .input-group button {
      padding: 10px 16px;
      font-size: 16px;
      background: #0078D7;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    td input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .btn-remove {
      background: #d9534f;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .save-btn {
      margin-top: 15px;
      background: #28a745;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }

    .status {
      text-align: center;
      margin-top: 15px;
      font-style: italic;
      color: gray;
    }

    @media (max-width: 600px) {
      h2 { font-size: 20px; }
      .input-group button, .save-btn { width: 100%; }
      .input-group { flex-direction: column; }
    }
  </style>
</head>
<body>

  <div class="wrapper">
    <a href="index.html" class="btn-back">‚Ü©Ô∏èüì¶ Th√™m s·∫£n ph·∫©m m·ªõi</a>
    <h2>üåü Qu·∫£n l√Ω h√£ng s·∫£n ph·∫©m</h2>

    <div class="status" id="tokenStatus"></div>

    <div class="input-group">
      <input type="text" id="brandInput" placeholder="Th√™m h√£ng m·ªõi (VD: ASAHI)" />
      <button onclick="addBrand()">Th√™m h√£ng</button>
    </div>

    <table>
      <thead><tr><th>T√™n h√£ng</th><th>H√†nh ƒë·ªông</th></tr></thead>
      <tbody id="brandTableBody"></tbody>
    </table>

    <button class="save-btn" onclick="saveBrandsToDropbox()">üíæ L∆∞u danh s√°ch h√£ng v√†o Dropbox</button>
    <div class="status" id="statusText">üìå B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a t√™n h√£ng ho·∫∑c x√≥a n·∫øu c·∫ßn</div>
  </div>

  <script>
    const token = localStorage.getItem("dropbox_token");
    if (!token) {
      alert("üö´ B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p token! ƒêang quay v·ªÅ trang ch√≠nh...");
      window.location.href = "index.html";
    } else {
      window.DROPBOX_ACCESS_TOKEN = token;
      document.getElementById("tokenStatus").innerText = "üîê Token ƒë√£ ƒë∆∞·ª£c n·∫°p!";
    }

    let brands = [];

    function renderBrands() {
      const tbody = document.getElementById("brandTableBody");
      tbody.innerHTML = "";
      brands.forEach((brand, index) => {
        tbody.innerHTML += `
          <tr>
            <td><input value="${brand}" onchange="updateBrand(${index}, this.value)" /></td>
            <td><button class="btn-remove" onclick="removeBrand(${index})">X√≥a</button></td>
          </tr>
        `;
      });
    }

    function addBrand() {
      const input = document.getElementById("brandInput");
      const name = input.value.trim();
      if (name && !brands.includes(name)) {
        brands.push(name);
        input.value = "";
        renderBrands();
      }
    }

    function updateBrand(index, value) {
      brands[index] = value.trim();
      renderBrands();
    }

    function removeBrand(index) {
      brands.splice(index, 1);
      renderBrands();
    }

    async function saveBrandsToDropbox() {
      const statusText = document.getElementById("statusText");
      statusText.innerText = "üîÑ ƒêang l∆∞u danh s√°ch h√£ng l√™n Dropbox...";
      try {
        const res = await fetch("https://content.dropboxapi.com/2/files/upload", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${window.DROPBOX_ACCESS_TOKEN}`,
            "Dropbox-API-Arg": JSON.stringify({
              path: "/hangmau/config.json", mode: "overwrite", autorename: false
            }),
            "Content-Type": "application/octet-stream"
          },
          body: JSON.stringify(brands, null, 2)
        });
        statusText.innerText = res.ok
          ? "‚úÖ ƒê√£ l∆∞u danh s√°ch h√£ng v√†o Dropbox!"
          : `‚ùå L·ªói l∆∞u: ${res.status}`;
      } catch (err) {
        statusText.innerText = `‚ö†Ô∏è L∆∞u th·∫•t b·∫°i: ${err.message}`;
      }
    }

    async function loadBrandsFromDropbox() {
      const statusText = document.getElementById("statusText");
      try {
        const res = await fetch("https://content.dropboxapi.com/2/files/download", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${window.DROPBOX_ACCESS_TOKEN}`,
            "Dropbox-API-Arg": JSON.stringify({ path: "/hangmau/config.json" })
          }
        });

        if (res.ok) {
          const data = await res.json();
          if (Array.isArray(data)) {
            brands = data;
            renderBrands();
            statusText.innerText = "‚úÖ ƒê√£ t·∫£i danh s√°ch h√£ng t·ª´ Dropbox.";
          } else {
            statusText.innerText = "‚ö†Ô∏è D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá trong config.json.";
          }
        } else if (res.status === 409) {
          statusText.innerText = "‚ÑπÔ∏è Ch∆∞a c√≥ file config.json. Nh·∫•n üíæ ƒë·ªÉ t·∫°o!";
        } else {
          statusText.innerText = `‚ùå L·ªói khi t·∫£i: ${res.status}`;
        }
      } catch (err) {
        statusText.innerText = `‚ö†Ô∏è L·ªói khi t·∫£i h√£ng: ${err.message}`;
      }
    }

    window.addEventListener("DOMContentLoaded", loadBrandsFromDropbox);
  </script>
</body>
</html>
